# NPU Perf JSON æ–‡ä»¶æ ¼å¼README 

---

## Version: 2025.5.22 ---by czy

æœ¬æ–‡æ¡£ä»¥ResNet50ä¸ºä¾‹ï¼Œç”¨äºè¯´æ˜æ¨¡å‹è½¬æ¢åçš„ JSON æ–‡ä»¶ç»“æ„ï¼ŒåŒ…æ‹¬å„å­—æ®µçš„å«ä¹‰ã€å±‚ç»“æ„ã€èåˆç­–ç•¥å’Œæ³¨æ„äº‹é¡¹ã€‚

---

## ğŸ§¾ æ–‡ä»¶æ•´ä½“ç»“æ„

è¯¥ JSON æ–‡ä»¶ä¸ºä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªä¸»å­—æ®µï¼š

```json
{
  "input_names": [...],
  "layers": [...]
}
```
---
## 1. input_names ä¸»å­—æ®µ

	â€¢	ç±»å‹ï¼šList[str]
	â€¢	è¯´æ˜ï¼šæ¨¡å‹å›¾çš„è¾“å…¥åç§°åˆ—è¡¨ã€‚
	
ç¤ºä¾‹ï¼š
```json
"input_names": ["data_input"]
```
---

## 2. layers ä¸»å­—æ®µ
	â€¢	ç±»å‹ï¼šList[LayerObject]
	â€¢	è¯´æ˜ï¼šè¡¨ç¤ºæ¨¡å‹ä¸­æ¯ä¸€å±‚çš„è®¡ç®—èŠ‚ç‚¹ï¼ˆç®—å­ï¼‰ï¼ŒæŒ‰ç…§æ‰§è¡Œé¡ºåºæ’åˆ—ã€‚

æ¯ä¸ª LayerObject çš„ç»“æ„å¦‚ä¸‹ï¼š
```json
{
  "op_type": "qnn.csi.conv2d",
  "name": "conv2d_conv1_fuse_bias_add_relu_1",
  "attrs": { ... },
  "inputs": [ ... ],
  "outputs": [ ... ]
}
```

---

## 3. layers ä¸»å­—æ®µè§£æ

ğŸ”¹ op_type

	â€¢	ç±»å‹ï¼šstr
	â€¢	è¯´æ˜ï¼šè¯¥å±‚ç®—å­çš„ç±»å‹ï¼Œå·²æ ‡å‡†åŒ–å¹¶å¸¦æœ‰å‰ç¼€ qnn.csi.ã€‚
	â€¢	ç¤ºä¾‹ï¼š
	â€¢	qnn.csi.conv2d
	â€¢	qnn.csi.relu
	â€¢	qnn.csi.add
	â€¢	qnn.csi.reshape



ğŸ”¹ name

	â€¢	ç±»å‹ï¼šstr
	â€¢	è¯´æ˜ï¼šè¯¥å±‚çš„å”¯ä¸€åç§°ã€‚å¸¸å¸¦æœ‰èåˆä¿¡æ¯ï¼Œå¦‚ _fuse_add, _fuse_reluï¼Œè¡¨ç¤ºæœ¬å±‚å·²èåˆå…¶ä»–ç®—å­ã€‚



ğŸ”¹ attrs

	â€¢	ç±»å‹ï¼šdict
	â€¢	è¯´æ˜ï¼šè¯¥å±‚çš„å±æ€§ä¿¡æ¯ï¼Œä¸åŒç®—å­æœ‰ä¸åŒå­—æ®µã€‚

#### Conv2D å¸¸è§å±æ€§å­—æ®µï¼š

| å±æ€§å         | ç±»å‹         | è¯´æ˜                         |
|----------------|--------------|------------------------------|
| `channels`     | int          | è¾“å‡ºé€šé“æ•°                   |
| `kernel_size`  | [int, int]   | å·ç§¯æ ¸å¤§å°                   |
| `strides`      | [int, int]   | æ­¥é•¿                         |
| `padding`      | [int, int, int, int] | ä¸Šä¸‹å·¦å³ padding |
| `groups`       | int          | åˆ†ç»„å·ç§¯æ•°                   |
| `dilation`     | [int, int]   | è†¨èƒ€ç³»æ•°                     |
| `data_layout`  | str          | æ•°æ®æ ¼å¼ï¼Œä¸€èˆ¬ä¸º `NCHW`      |
| `kernel_layout`| str          | æƒé‡æ ¼å¼ï¼Œå¦‚ `OIHW`          |

---

### ğŸ”¹ `inputs` / `outputs`

- ç±»å‹ï¼š`List[TensorObject]`
- æ¯ä¸ªè¾“å…¥æˆ–è¾“å‡ºæ˜¯ä¸€ä¸ª Tensor å¯¹è±¡ï¼š

```json
{
  "name": "tensor_0",
  "dim": [1, 64, 112, 112],
  "is_const": 0,
  "layout": "NCHW"
}
```

#### å­—æ®µè¯´æ˜ï¼š

| å­—æ®µå      | ç±»å‹         | è¯´æ˜                          |
|-------------|--------------|-------------------------------|
| `name`      | str          | Tensor åç§°ï¼ˆè¿æ¥ä¸Šä¸‹å±‚ï¼‰     |
| `dim`       | List[int]    | Tensor ç»´åº¦ï¼Œå½¢å¦‚ [N, C, H, W] |
| `is_const`  | int (0 or 1) | æ˜¯å¦ä¸ºå¸¸é‡ï¼ˆå¦‚æƒé‡ï¼‰           |
| `layout`    | str          | æ•°æ®å¸ƒå±€ï¼Œå¸¸è§ä¸º `NCHW`        |

---

## 4. å¯èƒ½çš„èåˆé€»è¾‘è¯´æ˜ï¼ˆop fusionï¼‰

å‚è€ƒé˜¿é‡Œç„é“: https://www.xrvm.cn/document?temp=graph-optimization&slug=hhb

åœ¨æ¨¡å‹è½¬æ¢è¿‡ç¨‹ä¸­è¿›è¡Œèåˆä¼˜åŒ–ä»¥æå‡æ•ˆç‡ã€‚å¸¸è§çš„èåˆæ¨¡å¼å¦‚ä¸‹ï¼š

| èåˆæ¨¡å¼                | åˆå¹¶åˆ°çš„ç®—å­ | è¯´æ˜                            |
|-------------------------|--------------|---------------------------------|
| Conv + BiasAdd          | Conv2D       | Bias åˆå¹¶è¿› conv æƒé‡åç½®       |
| Conv + Add / Mul        | Conv2D       | å…ƒç´ çº§æ“ä½œåˆå…¥ Conv è¾“å‡ºåå¤„ç†   |
| Conv + ReLU / Clip      | Conv2D       | æ¿€æ´»å‡½æ•°åˆå…¥å·ç§¯å               |
| Pad + Conv              | Conv2D       | é€šè¿‡ä¿®æ”¹ padding å®ç°èåˆ       |
| Reshape + Dense (Gemm)  | Dense        | å°† reshape åˆå¹¶åˆ°å…¨è¿æ¥å±‚è¾“å…¥ç«¯ |
| LayerNorm å­å›¾æ¨¡å¼       | LayerNorm    | å¤šä¸ªç®—å­è¯†åˆ«åˆå¹¶æˆ LayerNorm    |

åˆå¹¶ä¿¡æ¯é€šå¸¸ä½“ç°åœ¨ `name` å­—æ®µä¸­ï¼Œå¦‚ï¼š

```json
"name": "conv2d_block1_fuse_bias_add_relu"
```


## ğŸ“Œ ç¤ºä¾‹å±‚ï¼ˆConv + ReLU èåˆï¼‰

```json
{
  "op_type": "qnn.csi.conv2d",
  "name": "conv2d_conv1_fuse_bias_add_relu_1",
  "attrs": {
    "channels": 64,
    "kernel_size": [7, 7],
    "strides": [2, 2],
    "padding": [3, 3, 3, 3],
    "groups": 1,
    "dilation": [1, 1],
    "data_layout": "NCHW",
    "kernel_layout": "OIHW"
  },
  "inputs": [...],
  "outputs": [...]
}
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. æ‰€æœ‰æ•°æ®ç»´åº¦ä½¿ç”¨ `NCHW` æ ¼å¼è¡¨ç¤ºã€‚
2. `is_const = 1` è¡¨ç¤ºè¾“å…¥æ˜¯å¸¸é‡ï¼ˆæƒé‡ã€åç½®ã€å‡å€¼ç­‰ï¼‰ã€‚
3. ä¸åŒç±»å‹çš„ç®—å­å¯èƒ½ç¼ºå¤± `attrs` å­—æ®µï¼ˆå¦‚ ReLUã€Addï¼‰ã€‚
4. `output` çš„ `name` å°†ä½œä¸ºä¸‹æ¸¸å±‚ `input` çš„ `name`ã€‚

---

## âœ… æ¨èå·¥å…·é“¾æ”¯æŒ

- ONNX â†’ JSON è½¬æ¢è„šæœ¬ï¼ˆè‡ªå®šä¹‰ï¼‰
- æ¨¡å‹ä¼˜åŒ–æ”¯æŒï¼ˆå›¾èåˆã€å¸¸é‡æŠ˜å ï¼‰
- åç«¯ç¡¬ä»¶ç¼–è¯‘å™¨ï¼ˆä¾æ® JSON å±‚ç”Ÿæˆä»£ç ï¼‰

---

å¦‚éœ€è¿›ä¸€æ­¥è§£ææŸå±‚ç»“æ„æˆ–æ·»åŠ è‡ªå®šä¹‰ç®—å­æ”¯æŒï¼Œå¯åœ¨æ­¤æ–‡æ¡£åŸºç¡€ä¸Šæ‰©å±•ã€‚


